package provide ttext 0.1

set dir [file dirname [info script]]

source [file join $dir ttext-langclass.tcl]

#package require critcl
::xo::lib::require critcl

::critcl::reset
::critcl::clibraries -L/opt/naviserver/lib -lunac -lexttextcat
::critcl::config I /opt/naviserver/include


if { [::xo::kit::debug_mode_p] } {
    ::critcl::cflags -DDEBUG
}

::critcl::cinit {
    // init_text
    RegisterExitHandlers(ip);
    ttext_InitModule(ip);


} {
    // init_exts
}

critcl::ccode {
    #include <string.h>
    #include <stdlib.h>
    #include <unac.h>
    #include <libexttextcat/textcat.h>

    #define CheckArgs(min,max,n,msg) \
                     if ((objc < min) || (objc >max)) { \
                         Tcl_WrongNumArgs(interp, n, objv, msg); \
                         return TCL_ERROR; \
                     }

    #define ASSOC_DATA_KEY_LangClass "ttext_LangClass"

    // static int ttext_ModuleInitialized;
    // static void *ttext_LangClass_handle;


    /*
    *----------------------------------------------------------------------
    *
    * ttext_UnaccentCmd --
    *
    *    http://home.gna.org/unac/  
    *
    * Results:
    *      TCL_OK or TCL_ERROR
    *
    * Side effects:
    *      
    *
    *----------------------------------------------------------------------
    */

    int ttext_UnaccentCmd(ClientData clientData,Tcl_Interp *interp,int objc,Tcl_Obj * const objv[]) {
	
	CheckArgs(3,3,1,"charset text");	
	
	int len;
	const char* charset = Tcl_GetString(objv[1]);
	const char* text = Tcl_GetStringFromObj(objv[2],&len);

	char* unaccented = 0;
	size_t unaccented_length = 0;
	
	if(unac_string(charset, text, len, &unaccented, &unaccented_length) < 0) {
	    Tcl_AddErrorInfo(interp,"unaccent: attempt to unaccent with the specified charset failed");
	    return TCL_ERROR;
	}
	
	Tcl_AppendResult(interp,unaccented,NULL);
	free(unaccented);
	
	return TCL_OK;
    }


    /*
    *----------------------------------------------------------------------
    *
    * ttext_LangClassCmd --
    *
    *    DESCRIPTION="Library implementing N-gram-based text categorization"
    *    HOMEPAGE="http://software.wise-guys.nl/libtextcat/"
    *    SRC_URI="http://dev-www.libreoffice.org/src/${PN}/${P}.tar.xz"
    *
    * Results:
    *      TCL_OK or TCL_ERROR
    *
    * Side effects:
    *      
    *
    *----------------------------------------------------------------------
    */

    int ttext_LangClassCmd(ClientData clientData,Tcl_Interp *interp,int objc,Tcl_Obj * const objv[]) {

	CheckArgs(2,2,1,"string");
	
	void *ttext_LangClass_handle = 
	    Tcl_GetAssocData(interp,
			     ASSOC_DATA_KEY_LangClass,
			     NULL);

	if (!ttext_LangClass_handle) {
	    Tcl_AddErrorInfo(interp,"ttext_LangClass_handle is null, exiting...\n");
	    return TCL_ERROR;
	}

	const char *buf = Tcl_GetString(objv[1]);
	char *result = textcat_Classify(ttext_LangClass_handle, buf, strlen(buf) + 1);
	Tcl_AppendResult(interp,result,NULL);

	
	return TCL_OK;
    }


    void ttext_LangClass_init(Tcl_Interp *interp) {
	// prefix is the directory path where fingerprints are stored
	const char prefix[] = "/opt/naviserver/share/libexttextcat/";
	const char conf[] = "/opt/naviserver/share/libexttextcat/fpdb.conf";
        void *ttext_LangClass_handle = special_textcat_Init(conf, prefix);

	if (!ttext_LangClass_handle) { 
	    fprintf(stderr,"Unable to init using '%s'.",conf);
	    // exit
	    // return TCL_ERROR;
	} 

	Tcl_SetAssocData(interp,
			 ASSOC_DATA_KEY_LangClass,
			 NULL,
			 ttext_LangClass_handle);

    }

    void ttext_LangClass_cleanup(Tcl_Interp *interp) {

	void *ttext_LangClass_handle = 
	    Tcl_GetAssocData(interp,
			     ASSOC_DATA_KEY_LangClass,
			     NULL);

	textcat_Done(ttext_LangClass_handle);
	Tcl_DeleteAssocData(interp,ASSOC_DATA_KEY_LangClass);
    }

    /*----------------------------------------------------------------------------
     |   Initialize Module
     |   Activated at module load to initialize shared object handles table.
     |   This is exported since we need it in HERE: tdominit.c.
     \---------------------------------------------------------------------------*/


    void ttext_InitModule(Tcl_Interp *interp) 
    {

	ttext_LangClass_init(interp);

	Tcl_CreateObjCommand(interp, "::ttext::__langclass", ttext_LangClassCmd, NULL, NULL);

	Tcl_CreateObjCommand(interp, "::ttext::unaccent", ttext_UnaccentCmd, NULL, NULL);
    }


    static void
    ExitHandler(ClientData clientData) {

	Tcl_Interp *interp = (Tcl_Interp *) clientData;
        ttext_LangClass_cleanup(clientData);
	Tcl_Release(interp);
    }

    static void ttext_ThreadExitProc(ClientData clientData)
    {
        void ttext_ExitProc(ClientData clientData);
	Tcl_DeleteExitHandler(ttext_ExitProc, clientData);
	ExitHandler(clientData);
    }

	void
        ttext_ExitProc(ClientData clientData) {
            Tcl_DeleteThreadExitHandler(ttext_ThreadExitProc, clientData);
            ExitHandler(clientData);
        }

	static void
        RegisterExitHandlers(ClientData clientData) {
            Tcl_Preserve(clientData);
            Tcl_CreateThreadExitHandler(ttext_ThreadExitProc, clientData);
            Tcl_CreateExitHandler(ttext_ExitProc,clientData);
        }


}

::critcl::cbuild [file normalize [info script]]
